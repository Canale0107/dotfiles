#!/usr/bin/env bash
set -euo pipefail
MSG_FILE="$1"
COMMIT_SOURCE="${2-}"
SHA="${3-}"

# merge/squash/rebase中などは触らない
if [[ "$COMMIT_SOURCE" == "merge" ]] || [[ "$COMMIT_SOURCE" == "squash" ]] || [[ -n "$SHA" ]]; then
  exit 0
fi

# 既にメッセージがあるなら何もしない（コメント行・空行は無視）
if grep -q '^[^#]' "$MSG_FILE" 2>/dev/null && grep '^[^#]' "$MSG_FILE" | grep -q '[^[:space:]]'; then
  exit 0
fi

DIFF="$(git diff --staged)"
[[ -z "$DIFF" ]] && exit 0

MODEL="$(git config --get ai.commit-model 2>/dev/null || echo "haiku")"
MSG="$(claude -p --model "$MODEL" "Output ONLY a single-line commit message in Conventional Commits format for the following diff. No explanation, no preamble, no quotes, no markdown, no signature. Just the commit message.

$DIFF")"
# 余計な行が含まれた場合は1行目だけ使う
MSG="$(printf "%s" "$MSG" | head -1)"
printf "%s\n" "$MSG" > "$MSG_FILE"
